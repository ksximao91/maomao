--// 服务
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = character:WaitForChild("HumanoidRootPart")

local devv = require(ReplicatedStorage.devv)
local Signal = devv.load("Signal")
local item = devv.load("v3item")

--// 配置
local autoatm = true
local attackInterval = 0.2

--// 获取拳头GUID
local qtid
for _, v in next, item.inventory.items do
    if v.name == 'Fists' then
        qtid = v.guid
        break
    end
end

--// 自动换服务器（随机优质服务器，玩家数>3）
local function hopServer()
    local success, result = pcall(function()
        return game:HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100")
    end)
    if success then
        local data = HttpService:JSONDecode(result)
        local Servers = {}
        for _, v in ipairs(data.data) do
            if v.playing < v.maxPlayers and v.playing > 3 then
                table.insert(Servers, v)
            end
        end
        if #Servers > 0 then
            local randomServer = Servers[math.random(1, #Servers)]
            TeleportService:TeleportToPlaceInstance(game.PlaceId, randomServer.id, LocalPlayer)
            task.wait(5)
        end
    end
end

--// 攻击ATM函数
local function attackATM()
    if not LocalPlayer.Character then return false end
    local rootPart = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return false end

    local anyATM = false
    local atmFolder = workspace:FindFirstChild("Game") and workspace.Game:FindFirstChild("Props") and workspace.Game.Props:FindFirstChild("ATM")
    if atmFolder then
        for _, atm in ipairs(atmFolder:GetChildren()) do
            if atm:IsA("Model") and (atm:GetAttribute("health") or 0) > 0 then
                anyATM = true
                local pos = atm:GetPivot().Position
                rootPart.CFrame = CFrame.new(pos.x, pos.y, pos.z)
                Signal.FireServer("equip", qtid)
                Signal.FireServer("meleeItemHit", "prop", {meleeType="meleepunch", guid=atm:GetAttribute("guid")})
            end
        end
    end
    return anyATM
end

--// 金钱光环逻辑
task.spawn(function()
    while task.wait(0.1) do
        local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            local cashFolder = workspace:FindFirstChild("Game") and workspace.Game:FindFirstChild("Entities") and workspace.Game.Entities:FindFirstChild("CashBundle")
            if cashFolder then
                for _, v in pairs(cashFolder:GetDescendants()) do
                    if v:IsA("ClickDetector") then
                        local pos = v.Parent:GetPivot().Position
                        if (rootPart.Position - pos).Magnitude <= 35 then
                            fireclickdetector(v)
                        end
                    end
                end
            end
        end
    end
end)

--// 主循环
task.spawn(function()
    while autoatm do
        local hasATM = false
        local success, result = pcall(function()
            hasATM = attackATM()
        end)

        -- 没有ATM或出错就换服
        if not success or not hasATM then
            hopServer()
            break
        end

        task.wait(attackInterval)
    end
end)
